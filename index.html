<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Absen Expo COMP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }
    .step { display: none; }
    .step.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hidden { display: none !important; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6" id="appContainer">
    <div class="text-center py-6">Mempersiapkan absen...</div>
  </div>

  <!-- FingerprintJS untuk identifikasi perangkat -->
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3.3.3/dist/fp.min.js"></script>

  <script>
    // üîë GANTI DENGAN WEB APP URL DARI GOOGLE APPS SCRIPT (LANGKAH 2)
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzu4rFG6ZyS10Bh__hHa3NyBHntEosKzkO-LfS3OzDCpe0Sjuxu8sSR4gCU5qZn8K0U/exec";

    // üîí Sandi lokal (hanya untuk bypass localStorage ‚Äî tidak dikirim ke server)
    const DEV_PASSWORD = "expo2025"; // ‚Üê Ganti dengan sandi rahasia-mu

    let deviceId = null;
    let currentStep = 1;

    // === Inisialisasi Fingerprint dan Cek Status Absen ===
    (async () => {
      try {
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        deviceId = result.visitorId;

        // Cek apakah sudah pernah absen di perangkat ini
        const saved = localStorage.getItem("absen_expo_comp");
        if (saved) {
          const data = JSON.parse(saved);
          if (data.deviceId === deviceId) {
            showAlreadySubmitted();
            return;
          }
        }

        renderForm();
      } catch (err) {
        console.error("Gagal load FingerprintJS", err);
        document.getElementById("appContainer").innerHTML = `
          <div class="text-center py-6 text-red-600">Gagal memuat. Coba refresh.</div>
        `;
      }
    })();

    function showAlreadySubmitted() {
      document.getElementById("appContainer").innerHTML = `
        <div class="text-center py-8">
          <div class="text-green-500 text-5xl mb-4">‚úì</div>
          <h2 class="text-xl font-bold text-gray-800">Absen Telah Dikirim!</h2>
          <p class="text-gray-600 mt-2 mb-4">Satu perangkat hanya boleh absen sekali.</p>
          <button
            onclick="requestOverride()"
            class="text-blue-600 text-sm font-medium hover:underline"
          >
            Butuh isi ulang? Masukkan sandi developer
          </button>
        </div>
      `;
    }

    function requestOverride() {
      const pass = prompt("Masukkan sandi developer untuk mengisi ulang:");
      if (pass === DEV_PASSWORD) {
        localStorage.removeItem("absen_expo_comp");
        location.reload();
      } else if (pass !== null) {
        alert("‚ùå Sandi salah! Hubungi panitia.");
      }
    }

    function renderForm() {
      document.getElementById("appContainer").innerHTML = `
        <form id="absenForm" class="space-y-5">
          <!-- Tahap 1: Nama & Gender -->
          <div id="step1" class="step active">
            <h2 class="text-lg font-bold text-gray-800">Langkah 1: Data Diri</h2>
            <div class="mt-4">
              <label class="block text-gray-700 text-sm mb-1">Nama Lengkap</label>
              <input
                type="text"
                id="nama"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Contoh: Anindya Putri"
              />
            </div>
            <div class="mt-3">
              <label class="block text-gray-700 text-sm mb-1">Jenis Kelamin</label>
              <div class="flex space-x-6 mt-1">
                <label class="inline-flex items-center">
                  <input type="radio" name="gender" value="L" required class="text-blue-600" />
                  <span class="ml-1 text-gray-700">Laki-laki</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="radio" name="gender" value="P" required class="text-blue-600" />
                  <span class="ml-1 text-gray-700">Perempuan</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Tahap 2: Tanggal -->
          <div id="step2" class="step">
            <h2 class="text-lg font-bold text-gray-800">Langkah 2: Tanggal Kehadiran</h2>
            <div class="mt-4 space-y-2">
              <label class="flex items-center">
                <input type="radio" name="tanggal" value="2025-01-07" required class="mr-2 text-blue-600" />
                <span class="text-gray-700">7 Januari 2025</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="tanggal" value="2025-01-09" required class="mr-2 text-blue-600" />
                <span class="text-gray-700">9 Januari 2025</span>
              </label>
            </div>
          </div>

          <!-- Tahap 3: Kehadiran -->
          <div id="step3" class="step">
            <h2 class="text-lg font-bold text-gray-800">Langkah 3: Konfirmasi Kehadiran</h2>
            <div class="mt-4">
              <div class="flex space-x-6">
                <label class="inline-flex items-center">
                  <input type="radio" name="hadir" value="ya" required class="text-green-600" onchange="toggleAlasan()" />
                  <span class="ml-1 text-gray-700">Bisa Hadir</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="radio" name="hadir" value="tidak" required class="text-red-600" onchange="toggleAlasan()" />
                  <span class="ml-1 text-gray-700">Tidak Bisa</span>
                </label>
              </div>
            </div>
            <div id="alasanContainer" class="hidden mt-3">
              <label class="block text-gray-700 text-sm mb-1">Alasan Tidak Bisa Hadir</label>
              <textarea
                id="alasan"
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                placeholder="Contoh: acara keluarga, sakit, dll."
              ></textarea>
            </div>
          </div>

          <!-- Navigasi -->
          <div class="flex justify-between mt-6">
            <button
              type="button"
              id="prevBtn"
              onclick="prevStep()"
              class="hidden px-4 py-2 text-gray-600 font-medium rounded-lg hover:bg-gray-100"
            >
              ‚Üê Sebelumnya
            </button>
            <button
              type="button"
              id="nextBtn"
              onclick="nextStep()"
              class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700"
            >
              Selanjutnya ‚Üí
            </button>
            <button
              type="submit"
              id="submitBtn"
              class="hidden px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700"
            >
              Kirim Absen
            </button>
          </div>
        </form>
      `;
      showStep(1);
    }

    function showStep(step) {
      currentStep = step;
      document.querySelectorAll(".step").forEach(el => el.classList.remove("active"));
      document.getElementById(`step${step}`).classList.add("active");

      const prev = document.getElementById("prevBtn");
      const next = document.getElementById("nextBtn");
      const submit = document.getElementById("submitBtn");

      if (step === 1) {
        prev.classList.add("hidden");
        next.classList.remove("hidden");
        submit.classList.add("hidden");
      } else if (step === 3) {
        prev.classList.remove("hidden");
        next.classList.add("hidden");
        submit.classList.remove("hidden");
      } else {
        prev.classList.remove("hidden");
        next.classList.remove("hidden");
        submit.classList.add("hidden");
      }
    }

    function nextStep() {
      const current = document.getElementById(`step${currentStep}`);
      const requiredInputs = current.querySelectorAll("[required]");
      let valid = true;

      // Validasi radio buttons
      const radioNames = new Set();
      requiredInputs.forEach(el => {
        if (el.type === "radio") radioNames.add(el.name);
      });
      radioNames.forEach(name => {
        if (!document.querySelector(`input[name="${name}"]:checked`)) valid = false;
      });

      // Validasi text/textarea
      requiredInputs.forEach(el => {
        if (el.type === "text" || el.tagName === "TEXTAREA") {
          if (!el.value.trim()) valid = false;
        }
      });

      if (!valid) {
        alert("Harap lengkapi semua kolom pada langkah ini.");
        return;
      }

      showStep(currentStep + 1);
    }

    function prevStep() {
      showStep(currentStep - 1);
    }

    function toggleAlasan() {
      const hadir = document.querySelector('input[name="hadir"]:checked')?.value;
      const container = document.getElementById("alasanContainer");
      const alasan = document.getElementById("alasan");

      if (hadir === "tidak") {
        container.classList.remove("hidden");
        alasan.setAttribute("required", "true");
      } else {
        container.classList.add("hidden");
        alasan.removeAttribute("required");
        alasan.value = "";
      }
    }

    // === Kirim ke Google Spreadsheet ===
    document.addEventListener("submit", async (e) => {
      if (e.target.id !== "absenForm") return;
      e.preventDefault();

      const formData = new FormData(e.target);
      const payload = {
        nama: formData.get("nama"),
        gender: formData.get("gender"),
        tanggal: formData.get("tanggal"),
        hadir: formData.get("hadir"),
        alasan: formData.get("alasan") || "",
        deviceId: deviceId
      };

      const btn = document.getElementById("submitBtn");
      const originalText = btn.innerText;
      btn.innerText = "Mengirim...";
      btn.disabled = true;

      try {
        const response = await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
          localStorage.setItem("absen_expo_comp", JSON.stringify({ deviceId }));
          alert("‚úÖ Absen berhasil dikirim!\nTerima kasih atas partisipasinya.");
          showAlreadySubmitted();
        } else {
          alert("‚ùå Gagal: " + (result.message || "Terjadi kesalahan."));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Gagal mengirim. Periksa koneksi internet.");
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>